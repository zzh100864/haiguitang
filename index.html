<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êµ∑ÈæüÊ±§ - Êé®ÁêÜËß£Ë∞ú</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --steam-dark: #171a21;
            --steam-blue: #1b2838;
            --steam-light: #66c0f4;
            --steam-highlight: #c7d5e0;
        }

        body {
            background: var(--steam-blue);
            color: var(--steam-highlight);
            font-family: 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            margin: 0;
            background-image: linear-gradient(45deg, rgba(0,0,0,0.3) 25%, transparent 25%), 
                            linear-gradient(-45deg, rgba(0,0,0,0.3) 25%, transparent 25%);
            background-size: 4px 4px;
        }

        /* Ê∑ªÂä†Âä®ÊÄÅËÉåÊôØ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(125deg, #1b2838 0%, #171a21 100%),
                url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z" fill="%2366c0f4" fill-opacity="0.1" fill-rule="evenodd"/%3E%3C/svg%3E');
            animation: backgroundAnimation 30s linear infinite;
            z-index: -1;
        }

        @keyframes backgroundAnimation {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 100% 100%;
            }
        }

        .game-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(23, 26, 33, 0.95);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(102, 192, 244, 0.3);
            border: 1px solid rgba(102, 192, 244, 0.2);
        }

        .scenario-box {
            background: rgba(27, 40, 56, 0.9);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--steam-light);
            position: relative;
            overflow: hidden;
            background: linear-gradient(
                135deg,
                rgba(27, 40, 56, 0.95),
                rgba(27, 40, 56, 0.8)
            );
        }

        .scenario-box::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 65%, rgba(102, 192, 244, 0.1));
            pointer-events: none;
        }

        .scenario-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                var(--steam-light), 
                transparent, 
                var(--steam-light));
            z-index: -1;
            border-radius: 12px;
            animation: borderGlow 3s linear infinite;
        }

        @keyframes borderGlow {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 200%;
            }
        }

        .question-box {
            background: rgba(27, 40, 56, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(102, 192, 244, 0.3);
        }

        .answer-box {
            background: rgba(27, 40, 56, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(102, 192, 244, 0.3);
        }

        .hint-box {
            background: rgba(27, 40, 56, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 77, 79, 0.3);
        }

        .game-title {
            color: var(--steam-light);
            text-align: center;
            margin-bottom: 2rem;
            font-weight: bold;
            text-shadow: 
                0 0 5px rgba(102, 192, 244, 0.5),
                0 0 10px rgba(102, 192, 244, 0.3),
                0 0 15px rgba(102, 192, 244, 0.2);
            font-size: 2.5rem;
            animation: glowingText 2s ease-in-out infinite alternate;
        }

        @keyframes glowingText {
            from {
                text-shadow: 
                    0 0 5px rgba(102, 192, 244, 0.5),
                    0 0 10px rgba(102, 192, 244, 0.3),
                    0 0 15px rgba(102, 192, 244, 0.2);
            }
            to {
                text-shadow: 
                    0 0 10px rgba(102, 192, 244, 0.7),
                    0 0 20px rgba(102, 192, 244, 0.5),
                    0 0 30px rgba(102, 192, 244, 0.3);
            }
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .stat-item {
            text-align: center;
            position: relative;
        }

        .stat-item h5 {
            color: var(--steam-light);
            margin-bottom: 0.5rem;
        }

        .stat-item span {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--steam-highlight);
        }

        .btn-custom {
            background: linear-gradient(to bottom, var(--steam-light), #4b89b5);
            border: none;
            color: var(--steam-dark);
            font-weight: bold;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            transition: all 0.3s;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
            background: linear-gradient(to bottom, #7dcbff, var(--steam-light));
        }

        .btn-custom:disabled {
            background: #4a5d75;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-custom::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(102, 192, 244, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonGlow 3s linear infinite;
        }

        @keyframes buttonGlow {
            0% {
                transform: rotate(45deg) translateX(-100%);
            }
            100% {
                transform: rotate(45deg) translateX(100%);
            }
        }

        .history-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
            scrollbar-width: thin;
            scrollbar-color: var(--steam-light) var(--steam-blue);
        }

        .history-container::-webkit-scrollbar {
            width: 8px;
            background: rgba(27, 40, 56, 0.5);
        }

        .history-container::-webkit-scrollbar-track {
            background: var(--steam-blue);
        }

        .history-container::-webkit-scrollbar-thumb {
            background: linear-gradient(
                to bottom,
                var(--steam-light),
                rgba(102, 192, 244, 0.5)
            );
            border-radius: 4px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(23, 26, 33, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--steam-blue);
            border-top: 5px solid var(--steam-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
        }

        .input-group {
            background: rgba(27, 40, 56, 0.95);
            padding: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--steam-light);
        }

        .input-group:focus-within {
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
            transform: translateY(-2px);
        }

        .form-control {
            background: rgba(199, 213, 224, 0.1);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
        }

        .form-control:focus {
            background: rgba(199, 213, 224, 0.2);
            border-color: var(--steam-light);
            color: var(--steam-highlight);
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .achievement {
            position: fixed;
            bottom: 20px;
            right: -300px;
            background: rgba(27, 40, 56, 0.95);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: right 0.5s ease-in-out;
            z-index: 1000;
        }

        .achievement.show {
            right: 20px;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            background: var(--steam-light);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-info {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--steam-highlight);
            font-style: italic;
        }

        .achievement-list {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(102, 192, 244, 0.2);
            background: rgba(27, 40, 56, 0.8);
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .achievement-item:last-child {
            border-bottom: none;
        }

        .achievement-item:hover {
            transform: translateX(5px);
            box-shadow: 
                -5px 0 15px rgba(102, 192, 244, 0.2),
                0 0 10px rgba(102, 192, 244, 0.1);
            border-color: rgba(102, 192, 244, 0.4);
        }

        /* ‰øÆÊîπÊ®°ÂºèÈÄâÊã©ÁöÑÊ†∑Âºè */
        .mode-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 2rem;
        }

        .mode-cards {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 2rem;
        }

        .mode-card {
            background: rgba(27, 40, 56, 0.9);
            padding: 3rem;
            border-radius: 15px;
            border: 1px solid var(--steam-light);
            width: 300px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.5s ease, box-shadow 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            transform-style: preserve-3d;
        }

        .mode-card:hover {
            transform: 
                translateY(-10px) 
                rotateX(5deg) 
                rotateY(5deg);
            box-shadow: 
                0 15px 35px rgba(102, 192, 244, 0.2),
                0 0 15px rgba(102, 192, 244, 0.3);
        }

        .mode-icon {
            font-size: 4rem;
            color: var(--steam-light);
            margin-bottom: 1rem;
        }

        .mode-card h4 {
            font-size: 1.5rem;
            color: var(--steam-light);
            margin-bottom: 0.5rem;
        }

        .mode-card p {
            color: var(--steam-highlight);
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Ê∑ªÂä†Âä®ÁîªÊïàÊûú */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mode-card {
            animation: fadeIn 0.5s ease-out;
        }

        .mode-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .room-info {
            background: rgba(27, 40, 56, 0.9);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }

        .player-card {
            background: rgba(102, 192, 244, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: 1px solid var(--steam-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-player {
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .turn-indicator {
            color: #4CAF50;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        #modeSelection {
            text-align: center;
        }

        #singlePlayerMode, #multiPlayerMode {
            display: none;
        }

        .room-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .copy-button {
            background: none;
            border: none;
            color: var(--steam-light);
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
        }

        .copy-button:hover {
            color: var(--steam-highlight);
        }

        #questionRemaining {
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.8;
        }

        .answer-reveal {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
        }

        .category-selection {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .category-group {
            flex: 1;
        }

        .category-group h4 {
            color: var(--steam-light);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .form-select {
            background: rgba(199, 213, 224, 0.1);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
            width: 100%;
        }

        .form-select:focus {
            background: rgba(199, 213, 224, 0.2);
            border-color: var(--steam-light);
            color: var(--steam-highlight);
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .answer-input-box {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
        }

        .answer-input-box small {
            display: block;
            margin-top: 0.5rem;
            color: var(--steam-highlight);
        }

        .correct-answer {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
        }

        .wrong-answer {
            background: rgba(244, 67, 54, 0.1);
            border-color: #F44336;
        }

        .back-to-lobby {
            margin-bottom: 1rem;
            text-align: left;
        }

        .back-to-lobby .btn-custom {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
        }

        .back-to-lobby .btn-custom:hover {
            background: rgba(102, 192, 244, 0.2);
            transform: translateY(-2px);
        }

        /* Âú®Â§ö‰∫∫Ê®°ÂºèÁïåÈù¢Ê∑ªÂä†ËøîÂõûÊåâÈíÆ */
        .back-to-lobby {
            margin-bottom: 1rem;
            text-align: left;
        }

        .back-to-lobby .btn-custom {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
        }

        .back-to-lobby .btn-custom:hover {
            background: rgba(102, 192, 244, 0.2);
            transform: translateY(-2px);
        }

        /* ÊàøÈó¥Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .room-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--steam-light);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator i {
            font-size: 0.8rem;
        }

        .status-indicator i.waiting {
            color: #ffc107;
            animation: blink 1s infinite;
        }

        .status-indicator i.playing {
            color: #4CAF50;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .player-card {
            position: relative;
            background: rgba(27, 40, 56, 0.9);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--steam-light);
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 192, 244, 0.2);
        }

        .player-card.current-player {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .host-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--steam-light);
            color: var(--steam-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .turn-indicator {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .room-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .player-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .player-stats i {
            color: var(--steam-light);
        }

        .chat-box {
            background: rgba(27, 40, 56, 0.8);
            border-radius: 8px;
            border: 1px solid var(--steam-light);
            margin-top: 1rem;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--steam-light);
        }

        .game-timer {
            text-align: center;
            font-size: 1.2rem;
            margin: 1rem 0;
            color: var(--steam-light);
        }

        /* Âú®Êàø‰∏ªÊéßÂà∂Âå∫ÂüüÊ∑ªÂä† */
        .host-controls {
            display: none;
        }

        /* Ê∑ªÂä†ËØ≠Èü≥ËÅäÂ§©Âå∫Âüü */
        .voice-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #voiceStatus {
            background: rgba(27, 40, 56, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--steam-light);
            color: var(--steam-light);
            animation: pulse 1.5s infinite;
        }

        #voiceStatus i {
            margin-right: 8px;
            color: #ff4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        #startGameBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #playerCountHint {
            margin-top: 5px;
            color: var(--steam-light);
        }

        .turn-indicator-message {
            background: rgba(27, 40, 56, 0.9);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            color: var(--steam-light);
            border: 1px solid var(--steam-light);
        }

        .turn-indicator-message.my-turn {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
            color: #4CAF50;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        #question:disabled, #askQuestion:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Âú® roomInfo div ‰∏≠Ê∑ªÂä† */
        .chat-area {
            margin-top: 1rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--steam-light);
        }

        .input-group {
            background: rgba(27, 40, 56, 0.95);
            padding: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--steam-light);
        }

        .input-group:focus-within {
            box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
            transform: translateY(-2px);
        }

        .form-control {
            background: rgba(199, 213, 224, 0.1);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
        }

        .form-control:focus {
            background: rgba(199, 213, 224, 0.2);
            border-color: var(--steam-light);
            color: var(--steam-highlight);
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .btn-custom {
            background: linear-gradient(to bottom, var(--steam-light), #4b89b5);
            border: none;
            color: var(--steam-dark);
            font-weight: bold;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            transition: all 0.3s;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
            background: linear-gradient(to bottom, #7dcbff, var(--steam-light));
        }

        .btn-custom:disabled {
            background: #4a5d75;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-custom::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(102, 192, 244, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonGlow 3s linear infinite;
        }

        @keyframes buttonGlow {
            0% {
                transform: rotate(45deg) translateX(-100%);
            }
            100% {
                transform: rotate(45deg) translateX(100%);
            }
        }

        /* Âú® style Ê†áÁ≠æ‰∏≠Ê∑ªÂä† */
        .chat-area {
            margin-top: 1rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--steam-light);
        }

        .chat-message {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-break: break-word;
        }

        .chat-message.self {
            background: rgba(102, 192, 244, 0.1);
            border: 1px solid var(--steam-light);
            align-self: flex-end;
        }

        .chat-message.other {
            background: rgba(27, 40, 56, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-self: flex-start;
        }

        .chat-message .sender {
            font-size: 0.8rem;
            color: var(--steam-light);
            margin-bottom: 0.2rem;
        }

        .chat-message .time {
            font-size: 0.7rem;
            color: rgba(199, 213, 224, 0.5);
            margin-top: 0.2rem;
            text-align: right;
        }

        .room-list-area {
            margin-top: 2rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
        }

        .room-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .room-item {
            background: rgba(27, 40, 56, 0.8);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-info {
            flex-grow: 1;
        }

        .room-categories {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--steam-light);
        }

        .category {
            background: rgba(102, 192, 244, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .join-btn {
            background: linear-gradient(to bottom, var(--steam-light), #4b89b5);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: var(--steam-dark);
            cursor: pointer;
            transition: all 0.3s;
        }

        .join-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 192, 244, 0.5);
        }

        .join-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ê∑ªÂä†Êàø‰∏ªÊéßÂà∂Èù¢ÊùøÊ†∑Âºè */
        .host-controls {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
        }

        .join-requests {
            margin-top: 1rem;
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(102, 192, 244, 0.2);
        }

        .request-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .admin-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .player-card:hover .admin-controls {
            opacity: 1;
        }

        .admin-controls .btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
        }

        .muted-badge {
            color: #ff4444;
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }

        .player-card {
            position: relative;
            padding-right: 4rem;
        }

        .steam-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .steam-dialog-content {
            background: linear-gradient(to bottom, #2a475e, #1b2838);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1.5rem;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .steam-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--steam-light);
        }

        .dialog-title {
            color: var(--steam-light);
            margin: 0;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--steam-light);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #fff;
        }

        .dialog-body {
            color: var(--steam-highlight);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .dialog-buttons .btn {
            min-width: 80px;
        }

        /* Âú®Â§ö‰∫∫Ê®°ÂºèÁöÑÂàÜÁ±ªÈÄâÊã©Ê†∑Âºè */
        .category-selection {
            background: rgba(27, 40, 56, 0.9);
            border: 1px solid var(--steam-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .category-group {
            margin-bottom: 1rem;
        }

        .category-group h4 {
            color: var(--steam-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .category-group select {
            width: 100%;
            background: rgba(27, 40, 56, 0.8);
            border: 1px solid var(--steam-light);
            color: var(--steam-highlight);
            padding: 0.5rem;
            border-radius: 4px;
        }

        .category-group select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(102, 192, 244, 0.3);
        }

        .category-group select option {
            background: var(--steam-blue);
            color: var(--steam-highlight);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">üê¢ Êµ∑ÈæüÊ±§ - Êé®ÁêÜËß£Ë∞ú üçú</h1>
        <div class="game-info">‰∏ÄÊ¨æÂÖÖÊª°Êô∫ÊÖß‰∏éË∂£Âë≥ÁöÑÊé®ÁêÜËß£Ë∞úÊ∏∏Êàè</div>

        <!-- Ê®°ÂºèÈÄâÊã©ÁïåÈù¢ -->
        <div class="mode-selection" id="modeSelection">
            <div class="mode-cards">
                <div class="mode-card" onclick="selectMode('single')">
                    <div class="mode-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <h4>Âçï‰∫∫Ê®°Âºè</h4>
                    <p>Áã¨Ëá™‰ΩìÈ™åÊé®ÁêÜËß£Ë∞úÁöÑ‰πêË∂£</p>
                </div>
                <div class="mode-card" onclick="selectMode('multi')">
                    <div class="mode-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h4>Â§ö‰∫∫Ê®°Âºè</h4>
                    <p>‰∏éÂ•ΩÂèã‰∏ÄËµ∑Á†¥Ëß£Ë∞úÈ¢ò</p>
                </div>
            </div>
        </div>

        <!-- Ê∏∏ÊàèÂÜÖÂÆπÂå∫Âüü -->
        <div id="gameContent" style="display: none;">
            <div class="back-to-lobby">
                <button class="btn btn-custom" onclick="backToLobby()">
                    <i class="fas fa-arrow-left"></i> ËøîÂõûÂ§ßÂéÖ
                </button>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <h5><i class="fas fa-question-circle"></i> Â∑≤ÈóÆÈóÆÈ¢ò</h5>
                    <span id="questionCount">0</span>
                </div>
                <div class="stat-item">
                    <h5><i class="fas fa-lightbulb"></i> Ââ©‰ΩôÊèêÁ§∫</h5>
                    <span id="hintCount">2</span>
                </div>
                <div class="stat-item">
                    <h5><i class="fas fa-trophy"></i> ÊàêÂ∞±ÁÇπÊï∞</h5>
                    <span id="achievementPoints">0</span>
                </div>
            </div>

            <div id="scenarioBox" class="scenario-box" style="display: none;">
                <h4><i class="fas fa-theater-masks"></i> ÂΩìÂâçÂú∫ÊôØ</h4>
                <p id="scenario"></p>
            </div>

            <div id="categorySelection" class="category-selection" style="display: none;">
                <div class="category-group">
                    <h4>ÊïÖ‰∫ãÁ±ªÂûã</h4>
                    <select id="storyType" class="form-select">
                        <option value="">-- ËØ∑ÈÄâÊã© --</option>
                    </select>
                </div>
                <div class="category-group">
                    <h4>ÈöæÂ∫¶Á≠âÁ∫ß</h4>
                    <select id="difficulty" class="form-select">
                        <option value="">-- ËØ∑ÈÄâÊã© --</option>
                    </select>
                </div>
                <div class="category-group">
                    <h4>ÊïÖ‰∫ã‰∏ªÈ¢ò</h4>
                    <select id="theme" class="form-select">
                        <option value="">-- ËØ∑ÈÄâÊã© --</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <button id="startGame" class="btn btn-custom btn-lg w-100" style="display: none;">
                    <i class="fas fa-play"></i> ÂºÄÂßãÊñ∞Ê∏∏Êàè
                </button>
            </div>

            <div id="gameControls" style="display: none;">
                <div class="mb-3">
                    <label for="question" class="form-label">
                        <i class="fas fa-question"></i> ÊèêÈóÆÔºàÂè™ËÉΩÈóÆÊòØ/Âê¶ÈóÆÈ¢òÔºâÔºö
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="question" placeholder="ËæìÂÖ•‰Ω†ÁöÑÈóÆÈ¢ò...">
                        <button class="btn btn-custom" id="askQuestion">
                            <i class="fas fa-paper-plane"></i> ÊèêÈóÆ
                        </button>
                    </div>
                </div>

                <button id="requestHint" class="btn btn-custom">
                    <i class="fas fa-lightbulb"></i> Ëé∑ÂèñÊèêÁ§∫
                </button>
                
                <!-- Êñ∞Â¢ûÁ≠îÊ°àÊåâÈíÆÔºåÈªòËÆ§Á¶ÅÁî® -->
                <button id="showAnswer" class="btn btn-custom" disabled>
                    <i class="fas fa-key"></i> Êü•ÁúãÁ≠îÊ°à
                    <small id="questionRemaining"></small>
                </button>
            </div>

            <div class="history-container mt-4">
                <h4><i class="fas fa-history"></i> Ê∏∏ÊàèËÆ∞ÂΩï</h4>
                <div id="history"></div>
            </div>

            <div class="achievement-list">
                <h4><i class="fas fa-trophy"></i> ÊàêÂ∞±ÂàóË°®</h4>
                <div class="achievement-item">
                    <div class="achievement-icon">üéØ</div>
                    <div>
                        <h5>ÂàùÊ¨°Á†¥Ê°à</h5>
                        <p>ÊàêÂäüËß£ÂºÄÁ¨¨‰∏Ä‰∏™Ë∞úÈ¢ò</p>
                    </div>
                </div>
                <div class="achievement-item">
                    <div class="achievement-icon">üîç</div>
                    <div>
                        <h5>ÊïèÈîêÊ¥ûÂØü</h5>
                        <p>Áî®‰∏çË∂ÖËøá5‰∏™ÈóÆÈ¢òËß£ÂºÄË∞úÈ¢ò</p>
                    </div>
                </div>
            </div>

            <!-- Âú®Ê∏∏ÊàèÊéßÂà∂Âå∫ÂüüÊ∑ªÂä†Á≠îÊ°àËæìÂÖ•Ê°Ü -->
            <div id="answerInput" class="answer-input-box">
                <div class="input-group">
                    <input type="text" id="userAnswer" class="form-control" placeholder="ËæìÂÖ•‰Ω†ÁöÑÁ≠îÊ°à...">
                    <button class="btn btn-custom" id="submitAnswer">
                        <i class="fas fa-paper-plane"></i> Êèê‰∫§Á≠îÊ°à
                    </button>
                </div>
                <small id="answerAttempts" class="text-muted"></small>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <div id="achievement" class="achievement">
        <div class="achievement-icon">üèÜ</div>
        <div>
            <h5>Ëß£ÈîÅÊñ∞ÊàêÂ∞±ÔºÅ</h5>
            <p id="achievementText"></p>
        </div>
    </div>

    <!-- Âçï‰∫∫Ê®°ÂºèÁïåÈù¢ -->
    <div id="singlePlayerMode">
        <!-- ... (ÂéüÊúâÁöÑÂçï‰∫∫Ê®°ÂºèÂÜÖÂÆπ) ... -->
    </div>

    <!-- Â§ö‰∫∫Ê®°ÂºèÁïåÈù¢ -->
    <div id="multiPlayerMode">
        <div class="back-to-lobby">
            <button class="btn btn-custom" onclick="backToLobby()">
                <i class="fas fa-arrow-left"></i> ËøîÂõûÂ§ßÂéÖ
            </button>
        </div>

        <!-- ÊàøÈó¥Áä∂ÊÄÅÊåáÁ§∫Âô® -->
        <div class="room-status">
            <div class="status-indicator">
                <i class="fas fa-circle"></i> 
                <span id="roomStatus">Á≠âÂæÖ‰∏≠</span>
            </div>
            <div class="player-count">
                <i class="fas fa-users"></i> 
                <span id="playerCount">1/8</span>
            </div>
        </div>
        
        <!-- ÂàõÂª∫/Âä†ÂÖ•ÊàøÈó¥ -->
        <div id="roomJoinCreate">
            <div class="mb-3">
                <button class="btn btn-custom btn-lg w-100" onclick="showCreateRoom()">
                    <i class="fas fa-plus"></i> ÂàõÂª∫ÊàøÈó¥
                </button>
            </div>
            
            <!-- Ê∑ªÂä†Áé©ÂÆ∂ÂêçÁß∞ËæìÂÖ•ÂíåÊàøÈó¥ÂàóË°® -->
            <div class="room-list-area">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="playerNameInput" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó...">
                    </div>
                </div>
                <h4><i class="fas fa-list"></i> ÂèØÁî®ÊàøÈó¥</h4>
                <div id="roomList" class="room-list">
                    <!-- ÊàøÈó¥ÂàóË°®Â∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÊ∑ªÂä† -->
                </div>
            </div>
        </div>

        <!-- ÊàøÈó¥‰ø°ÊÅØ -->
        <div id="roomInfo" style="display: none;">
            <div class="room-info">
                <h4>ÊàøÈó¥‰ø°ÊÅØ</h4>
                <p>ÊàøÈó¥ID: <span id="roomId"></span> 
                    <button class="copy-button" onclick="copyRoomId()">
                        <i class="fas fa-copy"></i>
                    </button>
                </p>
                <div class="player-list" id="playerList"></div>
            </div>

            <!-- Ê∑ªÂä†ËÅäÂ§©Âå∫Âüü -->
            <div class="chat-area">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                        <button class="btn btn-custom" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i> ÂèëÈÄÅ
                        </button>
                    </div>
                </div>
            </div>

            <div id="hostControls" style="display: none;">
                <div class="join-requests">
                    <h5><i class="fas fa-user-plus"></i> Âä†ÂÖ•ËØ∑Ê±Ç</h5>
                    <div id="joinRequestsList">
                        <!-- Âä†ÂÖ•ËØ∑Ê±ÇÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÊ∑ªÂä† -->
                    </div>
                </div>
                <button id="startGameBtn" class="btn btn-custom" onclick="startMultiGame()" disabled>
                    <i class="fas fa-play"></i> ÂºÄÂßãÊ∏∏Êàè
                </button>
                <div id="playerCountHint" class="text-muted small">
                    ÈúÄË¶Å2-8ÂêçÁé©ÂÆ∂ÊâçËÉΩÂºÄÂßãÊ∏∏Êàè
                </div>
            </div>
        </div>

        <!-- Ê∏∏ÊàèÁïåÈù¢ -->
        <div id="gameInterface" style="display: none;">
            <!-- ... (‰∏éÂçï‰∫∫Ê®°ÂºèÁ±ª‰ººÁöÑÊ∏∏ÊàèÁïåÈù¢) ... -->
        </div>
    </div>

    <!-- Ê∑ªÂä†ËØ≠Èü≥ËÅäÂ§©Âå∫Âüü -->
    <div class="voice-chat">
        <div id="voiceStatus" class="d-none">
            <i class="fas fa-microphone"></i> Ê≠£Âú®ËØ¥ËØù...
        </div>
    </div>

    <!-- Ê∑ªÂä† Steam È£éÊ†ºÁöÑÂºπÊ°Ü HTML -->
    <div id="steamDialog" class="steam-dialog" style="display: none;">
        <div class="steam-dialog-content">
            <div class="steam-dialog-header">
                <h4 class="dialog-title"></h4>
                <button class="close-btn" onclick="closeSteamDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body"></div>
            <div class="dialog-buttons"></div>
        </div>
    </div>

    <script>
        // Âú® apiKey ÂèòÈáèÂÆö‰πâ‰πãÂâçÊ∑ªÂä†
        const STORY_CATEGORIES = {
            type: {
                'horror': 'ÊÅêÊÄñÊÉäÊÇö',
                'mystery': 'ÊÇ¨ÁñëÊé®ÁêÜ',
                'emotion': 'ÊÉÖÊÑüÊïÖ‰∫ã',
                'fantasy': 'Â•áÂπªÂÜíÈô©',
                'logic': 'ÈÄªËæëÊé®ÁêÜ',
                'career': 'ËÅå‰∏öÊïÖ‰∫ã'
            },
            difficulty: {
                'easy': 'ÁÆÄÂçïÂÖ•Èó®',
                'medium': '‰∏≠Á≠âÈöæÂ∫¶',
                'hard': 'È´òÈöæÂ∫¶ÊåëÊàò'
            },
            theme: {
                'daily': 'Êó•Â∏∏ÁîüÊ¥ª',
                'history': 'ÂéÜÂè≤ÊñáÂåñ',
                'scifi': 'ÁßëÂπªÊú™Êù•',
                'fairy': 'Á´•ËØùÁ•ûËØù'
            }
        };

        let apiKey = '';
        let currentRoom = null;
        let isHost = false;
        let playerName = '';
        let currentPlayer = '';
        let gameInterval = null;
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let gameMode = 'single'; // ÈªòËÆ§‰∏∫Âçï‰∫∫Ê®°Âºè

        // Ê∑ªÂä†ÂÖ®Â±ÄÂèòÈáè
        let isVoiceActive = false;
        let mediaRecorder = null;
        let audioChunks = [];

        // ‰øÆÊîπ API Ë∑ØÂæÑÂ∏∏Èáè
        const API = {
            single: {
                startGame: `${API_BASE_URL}/single/start_game`,
                askQuestion: `${API_BASE_URL}/single/ask_question`,
                requestHint: `${API_BASE_URL}/single/request_hint`,
                getAnswer: `${API_BASE_URL}/single/get_answer`,
                checkAnswer: `${API_BASE_URL}/single/check_answer`
            },
            multi: {
                createRoom: `${API_BASE_URL}/multi/create_room`,
                joinRoom: `${API_BASE_URL}/multi/join_room`,
                startGame: `${API_BASE_URL}/multi/start_game`,
                askQuestion: `${API_BASE_URL}/multi/ask_question`,
                requestHint: `${API_BASE_URL}/multi/request_hint`,
                getRoomStatus: `${API_BASE_URL}/multi/get_room_status`,
                checkAnswer: `${API_BASE_URL}/multi/check_answer`,
                sendVoice: `${API_BASE_URL}/multi/send_voice`,
                sendMessage: `${API_BASE_URL}/multi/send_message`,
                kickPlayer: `${API_BASE_URL}/multi/kick_player`,
                mutePlayer: `${API_BASE_URL}/multi/mute_player`
            }
        };

        async function getApiKey() {
            showLoading();
            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch(`${API_BASE_URL}/generate_key`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    apiKey = data.api_key;
                    hideLoading();
                    return;
                } catch (error) {
                    console.error('Ëé∑ÂèñAPIÂØÜÈí•Â§±Ë¥•ÔºåÂâ©‰ΩôÈáçËØïÊ¨°Êï∞:', retries - 1);
                    retries--;
                    if (retries === 0) {
                        throw new Error('Êó†Ê≥ïËé∑ÂèñAPIÂØÜÈí•');
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Á≠âÂæÖ1ÁßíÂêéÈáçËØï
                }
            }
            hideLoading();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function addToHistory(content, type) {
            const history = document.getElementById('history');
            const entry = document.createElement('div');
            entry.className = `${type}-box fade-in`;
            entry.innerHTML = content;
            history.insertBefore(entry, history.firstChild);
        }

        function selectMode(mode) {
            gameMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            
            if (mode === 'single') {
                document.getElementById('gameContent').style.display = 'block';
                document.getElementById('multiPlayerMode').style.display = 'none';
                // ÊòæÁ§∫ÂàÜÁ±ªÈÄâÊã©
                document.getElementById('categorySelection').style.display = 'block';
                // ÊòæÁ§∫ÂºÄÂßãÊ∏∏ÊàèÊåâÈíÆ
                document.getElementById('startGame').style.display = 'block';
            } else {
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('multiPlayerMode').style.display = 'block';
                document.getElementById('roomJoinCreate').style.display = 'block';
                document.getElementById('roomInfo').style.display = 'none';
                getRoomList();  // Á´ãÂç≥Ëé∑ÂèñÊàøÈó¥ÂàóË°®
            }
        }

        // ‰øÆÊîπÂàõÂª∫ÊàøÈó¥ÁöÑÂØπËØùÊ°ÜÂáΩÊï∞
        async function showCreateRoom() {
            // Ëé∑ÂèñÂàÜÁ±ªÈÄâÈ°πÁöÑHTML
            const categorySelectionHTML = `
                <div class="category-selection">
                    <div class="category-group">
                        <h4>ÊïÖ‰∫ãÁ±ªÂûã</h4>
                        <select id="createRoomStoryType" class="form-select">
                            <option value="">-- ËØ∑ÈÄâÊã© --</option>
                            ${Object.entries(STORY_CATEGORIES.type).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>ÈöæÂ∫¶Á≠âÁ∫ß</h4>
                        <select id="createRoomDifficulty" class="form-select">
                            <option value="">-- ËØ∑ÈÄâÊã© --</option>
                            ${Object.entries(STORY_CATEGORIES.difficulty).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>ÊïÖ‰∫ã‰∏ªÈ¢ò</h4>
                        <select id="createRoomTheme" class="form-select">
                            <option value="">-- ËØ∑ÈÄâÊã© --</option>
                            ${Object.entries(STORY_CATEGORIES.theme).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <input type="text" class="form-control" id="createRoomPlayerName" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó...">
                </div>
            `;

            showSteamDialog('ÂàõÂª∫ÊàøÈó¥', 'ÈÄâÊã©Ê∏∏ÊàèÁ±ªÂûãÂπ∂ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó:', [
                {
                    text: 'ÂàõÂª∫',
                    class: 'btn-primary',
                    onClick: async () => {
                        const name = document.getElementById('createRoomPlayerName').value.trim();
                        const storyType = document.getElementById('createRoomStoryType').value;
                        const difficulty = document.getElementById('createRoomDifficulty').value;
                        const theme = document.getElementById('createRoomTheme').value;
                        
                        if (!name) {
                            showSteamDialog('ÈîôËØØ', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂêçÂ≠ó', [{
                                text: 'Á°ÆÂÆö',
                                class: 'btn-danger',
                                onClick: () => showCreateRoom()
                            }]);
                            return;
                        }
                        
                        await createRoom(name, storyType, difficulty, theme);
                    }
                },
                {
                    text: 'ÂèñÊ∂à',
                    class: 'btn-secondary',
                    onClick: () => {}
                }
            ], categorySelectionHTML);
        }

        // ‰øÆÊîπÂàõÂª∫ÊàøÈó¥ÁöÑÂáΩÊï∞
        async function createRoom(name, storyType, difficulty, theme) {
            showLoading();
            try {
                if (!apiKey) {
                    await getApiKey();
                }

                const response = await fetch(API.multi.createRoom, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        host_name: name,
                        story_type: storyType,
                        difficulty: difficulty,
                        theme: theme
                    })
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    currentRoom = data.room_id;
                    isHost = true;
                    playerName = name;
                    
                    // Êõ¥Êñ∞ÁïåÈù¢
                    document.getElementById('roomJoinCreate').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('hostControls').style.display = 'block';
                    document.getElementById('roomId').textContent = data.room_id;
                    
                    // ÂºÄÂßãËΩÆËØ¢ÊàøÈó¥Áä∂ÊÄÅ
                    startPollingRoomStatus();
                    
                    showSteamDialog('ÊàêÂäü', 'ÊàøÈó¥ÂàõÂª∫ÊàêÂäüÔºÅ', [{
                        text: 'Á°ÆÂÆö',
                        class: 'btn-primary',
                        onClick: () => {}
                    }]);
                } else {
                    throw new Error(data.message || 'ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•:', error);
                showSteamDialog('ÈîôËØØ', `ÂàõÂª∫ÊàøÈó¥Â§±Ë¥•: ${error.message}`, [{
                    text: 'ÈáçËØï',
                    class: 'btn-primary',
                    onClick: () => showCreateRoom()
                }]);
            } finally {
                hideLoading();
            }
        }

        async function joinRoom() {
            const roomId = document.getElementById('joinRoomId').value.trim();
            const name = document.getElementById('joinPlayerName').value.trim();
            
            if (!roomId || !name) {
                alert('ËØ∑ËæìÂÖ•ÊàøÈó¥IDÂíåÁé©ÂÆ∂ÂêçÁß∞');
                return;
            }

            showLoading();
            try {
                // Á°Æ‰øùÂÖàËé∑Âèñ API key
                if (!apiKey) {
                    await getApiKey();
                }

                console.log('Joining room:', { roomId, name });
                
                const response = await fetch(API.multi.joinRoom, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: roomId,
                        player_name: name
                    })
                });

                console.log('Join room response status:', response.status);
                const data = await response.json();
                console.log('Join room response:', data);

                if (response.ok && data.status === 'success') {
                    currentRoom = roomId;
                    playerName = name;
                    isHost = false;
                    
                    // Êõ¥Êñ∞ÁïåÈù¢
                    document.getElementById('roomJoinCreate').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('roomId').textContent = roomId;
                    
                    // ÂºÄÂßãËΩÆËØ¢ÊàøÈó¥Áä∂ÊÄÅ
                    startPollingRoomStatus();
                    updatePlayerList(data.players);
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    alert('ÊàêÂäüÂä†ÂÖ•ÊàøÈó¥ÔºÅ');
                } else {
                    throw new Error(data.message || data.error || 'Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•:', error);
                alert(`Âä†ÂÖ•ÊàøÈó¥Â§±Ë¥•: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Ê∑ªÂä†Áé©ÂÆ∂ÁÆ°ÁêÜËèúÂçï
        function updatePlayerList(players = []) {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.name === currentPlayer ? 'current-player' : ''}`;
                
                // Ê∑ªÂä†Êàø‰∏ªÁÆ°ÁêÜËèúÂçï
                const adminControls = isHost && player.name !== playerName ? `
                    <div class="admin-controls">
                        <button class="btn btn-sm btn-custom" onclick="kickPlayer('${player.name}')">
                            <i class="fas fa-user-times"></i>
                        </button>
                        <button class="btn btn-sm btn-custom" onclick="mutePlayer('${player.name}')">
                            <i class="fas fa-microphone-slash"></i>
                        </button>
                    </div>
                ` : '';
                
                const muteStatus = player.muted_until && player.muted_until > Date.now() / 1000 ? 
                    '<span class="muted-badge"><i class="fas fa-microphone-slash"></i></span>' : '';
                
                playerCard.innerHTML = `
                    ${player.is_host ? '<span class="host-badge">Êàø‰∏ª</span>' : ''}
                    ${player.name === currentPlayer ? '<span class="turn-indicator">ÂΩìÂâçÂõûÂêà</span>' : ''}
                    <h5>${player.name} ${muteStatus}</h5>
                    <div class="player-stats">
                        <i class="fas fa-star"></i> ${player.score} ÂàÜ
                        <i class="fas fa-question-circle"></i> ${player.questions || 0} ÈóÆÈ¢ò
                    </div>
                    ${adminControls}
                `;
                
                playerList.appendChild(playerCard);
            });
        }

        // Ê∑ªÂä†Ë∏¢‰∫∫ÂäüËÉΩ
        async function kickPlayer(playerName) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü ${playerName} Ë∏¢Âá∫ÊàøÈó¥ÂêóÔºü`)) return;
            
            try {
                const response = await fetch(API.multi.kickPlayer, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        host_name: playerName,
                        player_name: playerName
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    throw new Error(data.message || 'Êìç‰ΩúÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ë∏¢Âá∫Áé©ÂÆ∂Â§±Ë¥•:', error);
                alert(error.message || 'Ë∏¢Âá∫Áé©ÂÆ∂Â§±Ë¥•');
            }
        }

        // Ê∑ªÂä†Á¶ÅË®ÄÂäüËÉΩ
        async function mutePlayer(playerName) {
            const duration = prompt('ËØ∑ËæìÂÖ•Á¶ÅË®ÄÊó∂ÈïøÔºàÂàÜÈíüÔºâ:', '5');
            if (!duration) return;
            
            try {
                const response = await fetch(API.multi.mutePlayer, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        host_name: playerName,
                        player_name: playerName,
                        duration: parseInt(duration) * 60
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    throw new Error(data.message || 'Êìç‰ΩúÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Á¶ÅË®ÄÁé©ÂÆ∂Â§±Ë¥•:', error);
                alert(error.message || 'Á¶ÅË®ÄÁé©ÂÆ∂Â§±Ë¥•');
            }
        }

        function startPollingRoomStatus() {
            if (gameInterval) {
                clearInterval(gameInterval);
            }
            gameInterval = setInterval(pollRoomStatus, 3000);
            pollRoomStatus(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°
        }

        async function pollRoomStatus() {
            if (!currentRoom) return;
            
            try {
                const response = await fetch(API.multi.getRoomStatus, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    updateRoomStatus(data.room_status);
                    updatePlayerCount(data.players.length);
                    updatePlayerList(data.players);
                    
                    // Â¶ÇÊûúÊòØÊàø‰∏ªÔºåÊõ¥Êñ∞Âä†ÂÖ•ËØ∑Ê±ÇÂàóË°®
                    if (isHost && data.join_requests) {
                        updateJoinRequests(data.join_requests);
                    }
                    
                    // Êõ¥Êñ∞ÂºÄÂßãÊ∏∏ÊàèÊåâÈíÆÁä∂ÊÄÅÔºà‰ªÖÊàø‰∏ªÂèØËßÅÔºâ
                    if (isHost) {
                        const startGameBtn = document.getElementById('startGameBtn');
                        if (startGameBtn) {
                            const playerCount = data.players.length;
                            // ‰øÆÊîπËøôÈáåÔºöÂΩìÁé©ÂÆ∂Êï∞ÈáèÂú®2-8‰∫∫‰πãÈó¥‰∏îÊ∏∏ÊàèÊú™ÂºÄÂßãÊó∂ÔºåÂêØÁî®ÂºÄÂßãÊåâÈíÆ
                            startGameBtn.disabled = playerCount < 2 || playerCount > 8 || data.room_status === 'playing';
                            document.getElementById('playerCountHint').textContent = 
                                data.room_status === 'playing' ? 'Ê∏∏ÊàèËøõË°å‰∏≠' :
                                playerCount < 2 ? 'Ëá≥Â∞ëÈúÄË¶Å2ÂêçÁé©ÂÆ∂' :
                                playerCount > 8 ? 'ÊúÄÂ§öÂÖÅËÆ∏8ÂêçÁé©ÂÆ∂' :
                                'ÂèØ‰ª•ÂºÄÂßãÊ∏∏Êàè';
                        }
                    }
                    
                    // Â¶ÇÊûúÊ∏∏ÊàèÂ∑≤ÁªèÂºÄÂßãÔºåÁ°Æ‰øùÊâÄÊúâÁé©ÂÆ∂ÈÉΩËÉΩÁúãÂà∞Ê∏∏ÊàèÁïåÈù¢
                    if (data.room_status === 'playing' && data.current_scenario) {
                        if (document.getElementById('gameContent').style.display === 'none') {
                            showGameInterface({
                                scenario: data.current_scenario,
                                hint_count: data.hint_count
                            });
                        }
                        
                        // Êõ¥Êñ∞Âú∫ÊôØÊñáÊú¨
                        document.getElementById('scenario').textContent = data.current_scenario;
                        
                        // Êõ¥Êñ∞ÂΩìÂâçÁé©ÂÆ∂Áä∂ÊÄÅ
                        updateCurrentPlayer(data.current_player);
                    }
                    
                    // Êõ¥Êñ∞ËÅäÂ§©Ê∂àÊÅØ
                    updateChatMessages(data.chat_messages);
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊàøÈó¥Áä∂ÊÄÅÂ§±Ë¥•:', error);
            }
        }

        function copyRoomId() {
            const roomId = document.getElementById('roomId').textContent;
            navigator.clipboard.writeText(roomId);
            alert('ÊàøÈó¥IDÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
        }

        async function startGame() {
            showLoading();
            try {
                // Á°Æ‰øù API key Â≠òÂú®
                if (!apiKey) {
                    await getApiKey();
                }

                const url = gameMode === 'single' ? API.single.startGame : API.multi.startGame;
                const storyType = document.getElementById('storyType').value;
                const difficulty = document.getElementById('difficulty').value;
                const theme = document.getElementById('theme').value;
                
                console.log('Starting game with:', { gameMode, storyType, difficulty, theme }); // Ë∞ÉËØïÊó•Âøó

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName,
                        story_type: storyType,
                        difficulty: difficulty,
                        theme: theme
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Game start response:', data); // Ë∞ÉËØïÊó•Âøó
                
                if (data.status === 'success') {
                    document.getElementById('scenario').textContent = data.scenario;
                    document.getElementById('scenarioBox').style.display = 'block';
                    document.getElementById('gameControls').style.display = 'block';
                    document.getElementById('startGame').textContent = 'ÈáçÊñ∞ÂºÄÂßã';
                    document.getElementById('hintCount').textContent = data.hint_count;
                    document.getElementById('questionCount').textContent = '0';
                    document.getElementById('history').innerHTML = '';
                    addToHistory(`<strong>Êñ∞Ê∏∏ÊàèÂºÄÂßãÔºÅ</strong><br>Âú∫ÊôØÔºö${data.scenario}`, 'scenario');
                    
                    // ÈáçÁΩÆÁ≠îÊ°àÁõ∏ÂÖ≥Áä∂ÊÄÅ
                    const showAnswerBtn = document.getElementById('showAnswer');
                    showAnswerBtn.disabled = true;
                    document.getElementById('questionRemaining').textContent = '(ËøòÈúÄ20‰∏™ÈóÆÈ¢ò)';
                    if (data.answer_attempts) {
                        document.getElementById('answerAttempts').textContent = 
                            `Ââ©‰ΩôÂ∞ùËØïÊ¨°Êï∞Ôºö${data.answer_attempts}`;
                    }
                } else {
                    throw new Error(data.message || 'ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•:', error);
                alert('ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function askQuestion() {
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('ËØ∑ËæìÂÖ•ÈóÆÈ¢ò');
                return;
            }

            showLoading();
            try {
                const url = gameMode === 'single' ? API.single.askQuestion : API.multi.askQuestion;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        question: question,
                        room_id: currentRoom,
                        player_name: playerName
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateQuestionCount(data.question_count);
                    addToHistory(`<strong>Q: ${question}</strong><br>A: ${data.answer}`, 'question');
                } else {
                    alert(data.message || 'ÊèêÈóÆÂ§±Ë¥•');
                }
                questionInput.value = '';
            } catch (error) {
                console.error('ÊèêÈóÆÂ§±Ë¥•:', error);
                alert('ÊèêÈóÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
            hideLoading();
        }

        async function requestHint() {
            showLoading();
            try {
                const url = gameMode === 'single' ? API.single.requestHint : API.multi.requestHint;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('hintCount').textContent = data.remaining_hints;
                    addToHistory(`<strong>ÊèêÁ§∫Ôºö</strong><br>${data.hint}`, 'hint');
                } else {
                    alert(data.message || 'Ëé∑ÂèñÊèêÁ§∫Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊèêÁ§∫Â§±Ë¥•:', error);
                alert('Ëé∑ÂèñÊèêÁ§∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
            hideLoading();
        }

        // Ê∑ªÂä†ÊàêÂ∞±Á≥ªÁªü
        function showAchievement(title) {
            const achievement = document.getElementById('achievement');
            document.getElementById('achievementText').textContent = title;
            achievement.classList.add('show');
            
            setTimeout(() => {
                achievement.classList.remove('show');
            }, 3000);
            
            // Êõ¥Êñ∞ÊàêÂ∞±ÁÇπÊï∞
            const points = document.getElementById('achievementPoints');
            points.textContent = parseInt(points.textContent) + 10;
        }

        // Êõ¥Êñ∞ÈóÆÈ¢òËÆ°Êï∞ÂíåÁ≠îÊ°àÊåâÈíÆÁä∂ÊÄÅÁöÑÂáΩÊï∞
        function updateQuestionCount(count) {
            const questionCount = document.getElementById('questionCount');
            const showAnswerBtn = document.getElementById('showAnswer');
            const questionRemaining = document.getElementById('questionRemaining');
            
            questionCount.textContent = count;
            
            if (gameMode === 'single') {
                const remainingQuestions = 20 - count;
                if (remainingQuestions > 0) {
                    showAnswerBtn.disabled = true;
                    questionRemaining.textContent = `(ËøòÈúÄ${remainingQuestions}‰∏™ÈóÆÈ¢ò)`;
                } else {
                    showAnswerBtn.disabled = false;
                    questionRemaining.textContent = '(ÂèØÊü•ÁúãÁ≠îÊ°à)';
                }
            }
        }

        // Ëé∑ÂèñÁ≠îÊ°àÁöÑÂáΩÊï∞
        async function showAnswer() {
            showLoading();
            try {
                const response = await fetch(API.single.getAnswer, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    addToHistory(`<strong>ÊúÄÁªàÁ≠îÊ°àÔºö</strong><br>${data.answer}`, 'answer-reveal');
                } else {
                    alert(data.message || 'Ëé∑ÂèñÁ≠îÊ°àÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÁ≠îÊ°àÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÁ≠îÊ°àÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
            hideLoading();
        }

        // Âú®ÂàùÂßãÂåñÊó∂Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆ
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_categories`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const categories = await response.json();
                console.log('Loaded categories:', categories); // Ë∞ÉËØïÊó•Âøó
                
                const storyTypeSelect = document.getElementById('storyType');
                const difficultySelect = document.getElementById('difficulty');
                const themeSelect = document.getElementById('theme');
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                storyTypeSelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã© --</option>';
                difficultySelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã© --</option>';
                themeSelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã© --</option>';
                
                // Â°´ÂÖÖÈÄâÈ°π
                if (categories.type) {
                    Object.entries(categories.type).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        storyTypeSelect.appendChild(option);
                    });
                }
                
                if (categories.difficulty) {
                    Object.entries(categories.difficulty).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        difficultySelect.appendChild(option);
                    });
                }
                
                if (categories.theme) {
                    Object.entries(categories.theme).forEach(([key, value]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = value;
                        themeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•:', error);
                alert('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }

        // Ê∑ªÂä†Êèê‰∫§Á≠îÊ°àÁöÑÂáΩÊï∞
        async function submitAnswer() {
            const answerInput = document.getElementById('userAnswer');
            const answer = answerInput.value.trim();
            
            if (!answer) {
                alert('ËØ∑ËæìÂÖ•Á≠îÊ°à');
                return;
            }

            showLoading();
            try {
                const url = gameMode === 'single' ? API.single.checkAnswer : API.multi.checkAnswer;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        answer: answer,
                        room_id: currentRoom,
                        player_name: playerName
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    const className = data.is_correct ? 'correct-answer' : 'wrong-answer';
                    addToHistory(`<strong>‰Ω†ÁöÑÁ≠îÊ°àÔºö</strong><br>${answer}<br><strong>ÁªìÊûúÔºö</strong>${data.message}`, className);
                    document.getElementById('answerAttempts').textContent = 
                        `Ââ©‰ΩôÂ∞ùËØïÊ¨°Êï∞Ôºö${data.remaining_attempts}`;
                    
                    if (data.is_correct) {
                        showAchievement('Ëß£Ë∞úÊàêÂäüÔºÅ');
                        setTimeout(() => {
                            if (confirm('ÊÅ≠Âñú‰Ω†Á≠îÂØπ‰∫ÜÔºÅË¶ÅÂºÄÂßãÊñ∞ÁöÑÊ∏∏ÊàèÂêóÔºü')) {
                                startGame();
                            }
                        }, 1500);
                    }
                    
                    answerInput.value = '';
                } else {
                    alert(data.message || 'Êèê‰∫§Á≠îÊ°àÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Êèê‰∫§Á≠îÊ°àÂ§±Ë¥•:', error);
                alert('Êèê‰∫§Á≠îÊ°àÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
            hideLoading();
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await getApiKey();
                console.log('API key obtained:', apiKey ? 'Yes' : 'No');
                
                if (!apiKey) {
                    throw new Error('Êó†Ê≥ïËé∑ÂèñAPIÂØÜÈí•');
                }
                
                await loadCategories();
                
                document.getElementById('startGame').addEventListener('click', startGame);
                document.getElementById('askQuestion').addEventListener('click', askQuestion);
                document.getElementById('requestHint').addEventListener('click', requestHint);
                document.getElementById('showAnswer').addEventListener('click', showAnswer);
                document.getElementById('submitAnswer').addEventListener('click', submitAnswer);
                
                document.getElementById('question').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        askQuestion();
                    }
                });

                document.getElementById('userAnswer').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitAnswer();
                    }
                });
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                alert('ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        });

        function backToLobby() {
            if (confirm('Á°ÆÂÆöË¶ÅËøîÂõûÂ§ßÂéÖÂêóÔºüÂΩìÂâçÊ∏∏ÊàèËøõÂ∫¶Â∞Ü‰∏ç‰ºö‰øùÂ≠ò„ÄÇ')) {
                // Ê∏ÖÈô§ËÆ°Êó∂Âô®
                if (gameTimer) {
                    clearInterval(gameTimer);
                    gameTimer = null;
                }
                
                // Ê∏ÖÈô§ËΩÆËØ¢
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                
                // ÈáçÁΩÆÁä∂ÊÄÅ
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('multiPlayerMode').style.display = 'none';
                document.getElementById('modeSelection').style.display = 'flex';
                document.getElementById('history').innerHTML = '';
                document.getElementById('scenarioBox').style.display = 'none';
                document.getElementById('gameControls').style.display = 'none';
                
                // ÈáçÁΩÆËÆ°Êï∞Âô®
                document.getElementById('questionCount').textContent = '0';
                document.getElementById('hintCount').textContent = '2';
                
                // Ê∏ÖÁ©∫ËæìÂÖ•
                document.getElementById('question').value = '';
                document.getElementById('userAnswer').value = '';
                document.getElementById('joinRoomId').value = '';
                document.getElementById('joinPlayerName').value = '';
                
                // ÈáçÁΩÆÂèòÈáè
                currentRoom = null;
                isHost = false;
                playerName = '';
                currentPlayer = '';
            }
        }

        // Ê∑ªÂä†Â§ö‰∫∫Ê®°ÂºèÁöÑÂäüËÉΩ
        function updateRoomStatus(status) {
            const statusIcon = document.querySelector('.status-indicator i');
            const statusText = document.getElementById('roomStatus');
            
            if (status === 'waiting') {
                statusIcon.className = 'fas fa-circle waiting';
                statusText.textContent = 'Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...';
            } else if (status === 'playing') {
                statusIcon.className = 'fas fa-circle playing';
                statusText.textContent = 'Ê∏∏ÊàèËøõË°å‰∏≠';
            }
        }

        function updatePlayerCount(current, max = 8) {
            document.getElementById('playerCount').textContent = `${current}/${max}`;
        }

        // Ê∑ªÂä†Ê∏∏ÊàèËÆ°Êó∂Âô®
        let gameTimer;
        function startGameTimer() {
            let seconds = 0;
            const timerElement = document.createElement('div');
            timerElement.className = 'game-timer';
            document.querySelector('.room-info').appendChild(timerElement);
            
            gameTimer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerElement.textContent = `Ê∏∏ÊàèÊó∂Èó¥: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ‰øÆÊîπ startMultiGame ÂáΩÊï∞
        async function startMultiGame() {
            try {
                if (!currentRoom || !playerName) {
                    throw new Error('ÊàøÈó¥‰ø°ÊÅØ‰∏çÂÆåÊï¥');
                }

                // Ëé∑ÂèñÊ∏∏ÊàèÁ±ªÂûãÈÄâÊã©
                const storyType = document.getElementById('multiStoryType').value;
                const difficulty = document.getElementById('multiDifficulty').value;
                const theme = document.getElementById('multiTheme').value;

                if (!storyType || !difficulty || !theme) {
                    throw new Error('ËØ∑ÈÄâÊã©Ê∏∏ÊàèÁ±ªÂûã„ÄÅÈöæÂ∫¶Âíå‰∏ªÈ¢ò');
                }

                console.log('Starting multiplayer game:', { currentRoom, playerName, storyType, difficulty, theme });

                const response = await fetch(API.multi.startGame, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName,
                        story_type: storyType,
                        difficulty: difficulty,
                        theme: theme
                    })
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
                    document.getElementById('startGameBtn').disabled = true;
                    updateRoomStatus('playing');
                    
                    // ÊòæÁ§∫Ê∏∏ÊàèÂÜÖÂÆπÁªôÊâÄÊúâÁé©ÂÆ∂
                    showGameInterface(data);

                    // Ê†πÊçÆÁé©ÂÆ∂Êï∞ÈáèËÆæÁΩÆÊâÄÈúÄÈóÆÈ¢òÊï∞
                    const requiredQuestions = data.player_count === 2 ? 15 : 20;
                    document.getElementById('questionRemaining').textContent = `(ËøòÈúÄ${requiredQuestions}‰∏™ÈóÆÈ¢ò)`;
                    
                    // ‰øùÂ≠òÊâÄÈúÄÈóÆÈ¢òÊï∞Âà∞ÂÖ®Â±ÄÂèòÈáè
                    window.requiredQuestions = requiredQuestions;
                } else {
                    throw new Error(data.message || data.error || 'ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•:', error);
                alert(`ÂºÄÂßãÊ∏∏ÊàèÂ§±Ë¥•: ${error.message}`);
            }
        }

        // ‰øÆÊîπ updateQuestionCount ÂáΩÊï∞
        function updateQuestionCount(count) {
            const questionCount = document.getElementById('questionCount');
            const showAnswerBtn = document.getElementById('showAnswer');
            const questionRemaining = document.getElementById('questionRemaining');
            
            questionCount.textContent = count;
            
            // Ëé∑ÂèñÂΩìÂâçÊâÄÈúÄÈóÆÈ¢òÊï∞ÔºàÈªòËÆ§20Ôºå‰∏§‰∫∫Êó∂‰∏∫15Ôºâ
            const requiredQuestions = window.requiredQuestions || 20;
            
            const remainingQuestions = requiredQuestions - count;
            if (remainingQuestions > 0) {
                showAnswerBtn.disabled = true;
                questionRemaining.textContent = `(ËøòÈúÄ${remainingQuestions}‰∏™ÈóÆÈ¢ò)`;
            } else {
                showAnswerBtn.disabled = false;
                questionRemaining.textContent = '(ÂèØÊü•ÁúãÁ≠îÊ°à)';
            }
        }

        // Âú®Êàø‰∏ªÊéßÂà∂Âå∫ÂüüÊ∑ªÂä†Ê∏∏ÊàèÁ±ªÂûãÈÄâÊã©
        function updateHostControls() {
            const hostControls = document.getElementById('hostControls');
            if (!hostControls) return;

            // Ê∑ªÂä†Ê∏∏ÊàèÁ±ªÂûãÈÄâÊã©ÁïåÈù¢
            const categorySelection = `
                <div class="category-selection">
                    <div class="category-group">
                        <h4>ÊïÖ‰∫ãÁ±ªÂûã</h4>
                        <select id="multiStoryType" class="form-select">
                            <option value="">-- ËØ∑ÈÄâÊã© --</option>
                            ${Object.entries(STORY_CATEGORIES.type).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>ÈöæÂ∫¶Á≠âÁ∫ß</h4>
                        <select id="multiDifficulty" class="form-select">
                            <option value="">-- ËØ∑ÈÄâÊã© --</option>
                            ${Object.entries(STORY_CATEGORIES.difficulty).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                    <div class="category-group">
                        <h4>ÊïÖ‰∫ã‰∏ªÈ¢ò</h4>
                        <select id="multiTheme" class="form-select">
                            <option value="">-- ËØ∑ÈÄâÊã© --</option>
                            ${Object.entries(STORY_CATEGORIES.theme).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;

            // Âú®ÂºÄÂßãÊ∏∏ÊàèÊåâÈíÆÂâçÊèíÂÖ•Á±ªÂûãÈÄâÊã©
            const startGameBtn = hostControls.querySelector('#startGameBtn');
            const categoryDiv = document.createElement('div');
            categoryDiv.innerHTML = categorySelection;
            hostControls.insertBefore(categoryDiv, startGameBtn);

            // Ê∑ªÂä†ÈÄâÊã©È™åËØÅ
            const validateGameSettings = () => {
                const storyType = document.getElementById('multiStoryType').value;
                const difficulty = document.getElementById('multiDifficulty').value;
                const theme = document.getElementById('multiTheme').value;
                const playerCount = document.querySelectorAll('.player-card').length;

                const startGameBtn = document.getElementById('startGameBtn');
                startGameBtn.disabled = !storyType || !difficulty || !theme || playerCount < 2 || playerCount > 8;

                const hint = document.getElementById('playerCountHint');
                if (!storyType || !difficulty || !theme) {
                    hint.textContent = 'ËØ∑ÈÄâÊã©Ê∏∏ÊàèÁ±ªÂûã„ÄÅÈöæÂ∫¶Âíå‰∏ªÈ¢ò';
                } else if (playerCount < 2) {
                    hint.textContent = 'Ëá≥Â∞ëÈúÄË¶Å2ÂêçÁé©ÂÆ∂';
                } else if (playerCount > 8) {
                    hint.textContent = 'ÊúÄÂ§öÂÖÅËÆ∏8ÂêçÁé©ÂÆ∂';
                } else {
                    hint.textContent = 'ÂèØ‰ª•ÂºÄÂßãÊ∏∏Êàè';
                }
            };

            // Ê∑ªÂä†ÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('multiStoryType').addEventListener('change', validateGameSettings);
            document.getElementById('multiDifficulty').addEventListener('change', validateGameSettings);
            document.getElementById('multiTheme').addEventListener('change', validateGameSettings);
        }

        // ‰øÆÊîπ showGameInterface ÂáΩÊï∞
        function showGameInterface(data) {
            // ... Áé∞Êúâ‰ª£Á†Å ...

            // Ê∑ªÂä†Áé©ÂÆ∂Êï∞ÈáèÂíåÊâÄÈúÄÈóÆÈ¢òÊï∞ÁöÑÊòæÁ§∫
            const playerCount = data.player_count || 2;
            const requiredQuestions = playerCount === 2 ? 15 : 20;
            window.requiredQuestions = requiredQuestions;

            // Êõ¥Êñ∞ÈóÆÈ¢òËÆ°Êï∞ÊòæÁ§∫
            document.getElementById('questionRemaining').textContent = `(ËøòÈúÄ${requiredQuestions}‰∏™ÈóÆÈ¢ò)`;
            
            // Â¶ÇÊûúÊòØÊàø‰∏ªÔºåÊòæÁ§∫ÂΩìÂâçÊ∏∏ÊàèËÆæÁΩÆ
            if (isHost) {
                const gameSettings = document.createElement('div');
                gameSettings.className = 'game-settings';
                gameSettings.innerHTML = `
                    <div class="mt-3 mb-3">
                        <h5>ÂΩìÂâçÊ∏∏ÊàèËÆæÁΩÆ</h5>
                        <p>
                            Á±ªÂûã: ${STORY_CATEGORIES.type[data.story_type] || 'Êú™ËÆæÁΩÆ'}<br>
                            ÈöæÂ∫¶: ${STORY_CATEGORIES.difficulty[data.difficulty] || 'Êú™ËÆæÁΩÆ'}<br>
                            ‰∏ªÈ¢ò: ${STORY_CATEGORIES.theme[data.theme] || 'Êú™ËÆæÁΩÆ'}<br>
                            ÊâÄÈúÄÈóÆÈ¢òÊï∞: ${requiredQuestions}
                        </p>
                    </div>
                `;
                document.getElementById('scenarioBox').appendChild(gameSettings);
            }
        }

        // Âú®ÊàøÈó¥ÂàõÂª∫Êó∂ÂàùÂßãÂåñÊàø‰∏ªÊéßÂà∂
        function initializeHostControls() {
            if (isHost) {
                updateHostControls();
            }
        }

        // Ê∑ªÂä†ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢ÁöÑÂáΩÊï∞
        function showGameInterface(data) {
            // ÈöêËóèÊàøÈó¥ÂàõÂª∫/Âä†ÂÖ•ÁïåÈù¢
            document.getElementById('roomJoinCreate').style.display = 'none';
            
            // ÊòæÁ§∫Ê∏∏ÊàèÂÜÖÂÆπ
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('scenarioBox').style.display = 'block';
            document.getElementById('scenario').textContent = data.scenario;
            document.getElementById('gameControls').style.display = 'block';
            
            // ÈáçÁΩÆÊ∏∏ÊàèËÆ°Êï∞Âô®
            document.getElementById('questionCount').textContent = '0';
            document.getElementById('hintCount').textContent = data.hint_count;
            
            // Ê∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
            document.getElementById('history').innerHTML = '';
            addToHistory(`<strong>Êñ∞Ê∏∏ÊàèÂºÄÂßãÔºÅ</strong><br>Âú∫ÊôØÔºö${data.scenario}`, 'scenario');
            
            // ÂºÄÂßãÊ∏∏ÊàèËÆ°Êó∂Âô®
            startGameTimer();
        }

        // Ê∑ªÂä†Êõ¥Êñ∞ÂΩìÂâçÁé©ÂÆ∂ÁöÑÂáΩÊï∞
        function updateCurrentPlayer(currentPlayerName) {
            const isMyTurn = currentPlayerName === playerName;
            
            // Êõ¥Êñ∞ÈóÆÈ¢òËæìÂÖ•Êéß‰ª∂Áä∂ÊÄÅ
            document.getElementById('question').disabled = !isMyTurn;
            document.getElementById('askQuestion').disabled = !isMyTurn;
            
            // Êõ¥Êñ∞ÂΩìÂâçÁé©ÂÆ∂ÊèêÁ§∫
            const turnIndicator = document.getElementById('turnIndicator') || createTurnIndicator();
            turnIndicator.textContent = isMyTurn ? 
                'Áé∞Âú®ÊòØ‰Ω†ÁöÑÂõûÂêàÔºåËØ∑ÊèêÈóÆ' : 
                `Áé∞Âú®ÊòØ ${currentPlayerName} ÁöÑÂõûÂêà`;
            turnIndicator.className = `turn-indicator-message ${isMyTurn ? 'my-turn' : ''}`;
        }

        // ÂàõÂª∫ÂõûÂêàÊèêÁ§∫ÂÖÉÁ¥†
        function createTurnIndicator() {
            const turnIndicator = document.createElement('div');
            turnIndicator.id = 'turnIndicator';
            turnIndicator.className = 'turn-indicator-message';
            const gameControls = document.getElementById('gameControls');
            gameControls.insertBefore(turnIndicator, gameControls.firstChild);
            return turnIndicator;
        }

        // Ê∑ªÂä†ËØ≠Èü≥ËÅäÂ§©ÂäüËÉΩ
        document.addEventListener('keydown', async (e) => {
            if (e.key.toLowerCase() === 't' && !isVoiceActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isVoiceActive = true;
                    document.getElementById('voiceStatus').classList.remove('d-none');
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                        sendVoiceMessage(audioBlob);
                    };
                    
                    mediaRecorder.start();
                } catch (error) {
                    console.error('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é:', error);
                    alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key.toLowerCase() === 't' && isVoiceActive) {
                isVoiceActive = false;
                document.getElementById('voiceStatus').classList.add('d-none');
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            }
        });

        // ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ
        async function sendVoiceMessage(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob);
                formData.append('room_id', currentRoom);
                formData.append('player_name', playerName);
                formData.append('X_API_KEY', apiKey);
                
                const response = await fetch(API.multi.sendVoice, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (!data.status === 'success') {
                    console.error('ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØÂ§±Ë¥•:', data.message);
                }
            } catch (error) {
                console.error('ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØÂ§±Ë¥•:', error);
            }
        }

        // Ê∑ªÂä†ÂèëÈÄÅËÅäÂ§©Ê∂àÊÅØÁöÑÂáΩÊï∞
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Ê£ÄÊü•ÊòØÂê¶Ë¢´Á¶ÅË®Ä
            const player = currentRoom?.players?.find(p => p.name === playerName);
            if (player?.muted_until && player.muted_until > Date.now() / 1000) {
                const remainingTime = Math.ceil((player.muted_until - Date.now() / 1000) / 60);
                alert(`‰Ω†Â∑≤Ë¢´Á¶ÅË®ÄÔºåËøòÂâ© ${remainingTime} ÂàÜÈíü`);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/multi/send_message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        player_name: playerName,
                        message: message
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    chatInput.value = '';
                }
            } catch (error) {
                console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
            }
        }

        // Ê∑ªÂä†Êõ¥Êñ∞ËÅäÂ§©Ê∂àÊÅØÁöÑÂáΩÊï∞
        function updateChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.sender === playerName ? 'self' : 'other'}`;
                messageDiv.innerHTML = `
                    <div class="sender">${msg.sender}</div>
                    <div class="content">${msg.content}</div>
                    <div class="time">${msg.time}</div>
                `;
                chatMessages.appendChild(messageDiv);
            });
            
            // ÊªöÂä®Âà∞ÊúÄÊñ∞Ê∂àÊÅØ
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Ê∑ªÂä†ÂõûËΩ¶ÂèëÈÄÅÊ∂àÊÅØÁöÑÂäüËÉΩ
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // ‰øÆÊîπËé∑ÂèñÊàøÈó¥ÂàóË°®ÁöÑÂáΩÊï∞
        async function getRoomList() {
            try {
                if (!apiKey) {
                    await getApiKey();
                }
                
                const response = await fetch(`${API_BASE_URL}/multi/get_rooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey
                    })
                });
                
                const data = await response.json();
                console.log('Get rooms response:', data);  // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
                
                if (data.status === 'success') {
                    updateRoomList(data.rooms);
                } else {
                    console.error('Ëé∑ÂèñÊàøÈó¥ÂàóË°®Â§±Ë¥•:', data.message);
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÊàøÈó¥ÂàóË°®Â§±Ë¥•:', error);
            }
        }

        // ‰øÆÊîπËØ∑Ê±ÇÂä†ÂÖ•ÊàøÈó¥ÁöÑÂáΩÊï∞
        async function requestJoinRoom(roomId) {
            try {
                const playerNameInput = document.getElementById('playerNameInput');
                const name = playerNameInput.value.trim();
                
                if (!name) {
                    alert('ËØ∑ÂÖàËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó');
                    playerNameInput.focus();
                    return;
                }
                
                showLoading();
                
                const response = await fetch(`${API_BASE_URL}/multi/request_join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: roomId,
                        player_name: name
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    playerName = name; // ‰øùÂ≠òÁé©ÂÆ∂ÂêçÁß∞
                    currentRoom = roomId; // ‰øùÂ≠òÊàøÈó¥ID
                    
                    // Êõ¥Êñ∞ÁïåÈù¢
                    document.getElementById('roomJoinCreate').style.display = 'none';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('roomId').textContent = roomId;
                    
                    // ÂºÄÂßãËΩÆËØ¢ÊàøÈó¥Áä∂ÊÄÅ
                    startPollingRoomStatus();
                    
                    alert('Â∑≤ÂèëÈÄÅÂä†ÂÖ•ËØ∑Ê±ÇÔºåÁ≠âÂæÖÊàø‰∏ªÂÆ°Ê†∏');
                } else {
                    throw new Error(data.message || 'ËØ∑Ê±ÇÂä†ÂÖ•Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ËØ∑Ê±ÇÂä†ÂÖ•ÊàøÈó¥Â§±Ë¥•:', error);
                alert(error.message || 'ËØ∑Ê±ÇÂä†ÂÖ•ÊàøÈó¥Â§±Ë¥•');
            } finally {
                hideLoading();
            }
        }

        // ‰øÆÊîπÊõ¥Êñ∞ÊàøÈó¥ÂàóË°®ÁöÑÂáΩÊï∞
        function updateRoomList(rooms) {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';
            
            if (rooms.length === 0) {
                roomList.innerHTML = '<div class="text-center p-3">ÂΩìÂâçÊ≤°ÊúâÂèØÁî®ÁöÑÊàøÈó¥</div>';
                return;
            }
            
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                roomDiv.innerHTML = `
                    <div class="room-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="room-id">ÊàøÈó¥ID: ${room.room_id}</span>
                            <span class="player-count">
                                <i class="fas fa-users"></i> ${room.player_count}/8
                            </span>
                        </div>
                        <div class="host-name">Êàø‰∏ª: ${room.host_name}</div>
                        <div class="room-status ${room.status === 'waiting' ? 'text-success' : 'text-warning'}">
                            <i class="fas fa-circle"></i> 
                            ${room.status === 'waiting' ? 'Á≠âÂæÖ‰∏≠' : 'Ê∏∏Êàè‰∏≠'}
                        </div>
                        <div class="room-categories">
                            ${room.story_type ? `<span class="category">Á±ªÂûã: ${STORY_CATEGORIES.type[room.story_type]}</span>` : ''}
                            ${room.difficulty ? `<span class="category">ÈöæÂ∫¶: ${STORY_CATEGORIES.difficulty[room.difficulty]}</span>` : ''}
                            ${room.theme ? `<span class="category">‰∏ªÈ¢ò: ${STORY_CATEGORIES.theme[room.theme]}</span>` : ''}
                        </div>
                    </div>
                    <button class="join-btn" onclick="requestJoinRoom('${room.room_id}')" 
                            ${room.status !== 'waiting' ? 'disabled' : ''}>
                        ${room.status === 'waiting' ? 'Âä†ÂÖ•ÊàøÈó¥' : 'Ê∏∏Êàè‰∏≠'}
                    </button>
                `;
                roomList.appendChild(roomDiv);
            });
        }

        // ‰øÆÊîπÂ§ÑÁêÜÂä†ÂÖ•ËØ∑Ê±ÇÁöÑÂáΩÊï∞
        async function handleJoinRequest(targetPlayerName, accept) {
            try {
                const response = await fetch(`${API_BASE_URL}/multi/handle_join_request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        X_API_KEY: apiKey,
                        room_id: currentRoom,
                        host_name: playerName,  // ‰ΩøÁî®ÂΩìÂâçÁé©ÂÆ∂ÂêçÁß∞ÔºàÊàø‰∏ªÔºâ
                        player_name: targetPlayerName,  // ‰ΩøÁî®ÁõÆÊ†áÁé©ÂÆ∂ÂêçÁß∞
                        accept: accept
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showSteamDialog('Êìç‰ΩúÊàêÂäü', data.message, [{
                        text: 'Á°ÆÂÆö',
                        class: 'btn-primary',
                        onClick: () => {}
                    }]);
                } else {
                    throw new Error(data.message || 'Â§ÑÁêÜËØ∑Ê±ÇÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Â§ÑÁêÜÂä†ÂÖ•ËØ∑Ê±ÇÂ§±Ë¥•:', error);
                showSteamDialog('ÈîôËØØ', error.message || 'Â§ÑÁêÜÂä†ÂÖ•ËØ∑Ê±ÇÂ§±Ë¥•', [{
                    text: 'Á°ÆÂÆö',
                    class: 'btn-danger',
                    onClick: () => {}
                }]);
            }
        }

        // ‰øÆÊîπÊõ¥Êñ∞Âä†ÂÖ•ËØ∑Ê±ÇÂàóË°®ÁöÑÂáΩÊï∞
        function updateJoinRequests(requests) {
            const requestsList = document.getElementById('joinRequestsList');
            if (!requestsList) return;
            
            requestsList.innerHTML = '';
            console.log('Updating join requests:', requests);
            
            if (!requests || requests.length === 0) {
                requestsList.innerHTML = '<div class="text-muted">ÊöÇÊó†Âä†ÂÖ•ËØ∑Ê±Ç</div>';
                return;
            }
            
            requests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'request-item';
                requestDiv.innerHTML = `
                    <span>${request.name} ËØ∑Ê±ÇÂä†ÂÖ•</span>
                    <div class="request-buttons">
                        <button class="btn btn-custom btn-sm" onclick="handleJoinRequest('${request.name}', true)">
                            <i class="fas fa-check"></i> Êé•Âèó
                        </button>
                        <button class="btn btn-custom btn-sm" onclick="handleJoinRequest('${request.name}', false)">
                            <i class="fas fa-times"></i> ÊãíÁªù
                        </button>
                    </div>
                `;
                requestsList.appendChild(requestDiv);
            });
        }

        // Ê∑ªÂä†ÂÆöÊó∂Âà∑Êñ∞ÊàøÈó¥ÂàóË°®ÁöÑÂäüËÉΩ
        setInterval(() => {
            if (!currentRoom) {  // Âè™Âú®Êú™Âä†ÂÖ•ÊàøÈó¥Êó∂Âà∑Êñ∞ÂàóË°®
                getRoomList();
            }
        }, 5000);

        // ÂÖ≥Èó≠ Steam È£éÊ†ºÂºπÊ°Ü
        function closeSteamDialog() {
            document.getElementById('steamDialog').style.display = 'none';
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂºπÊ°Ü
        document.addEventListener('DOMContentLoaded', () => {
            addSteamDialog();
        });

        // ‰øÆÊîπ showSteamDialog ÂáΩÊï∞ÊîØÊåÅËá™ÂÆö‰πâÂÜÖÂÆπ
        function showSteamDialog(title, message, buttons = [], customContent = '') {
            const dialog = document.getElementById('steamDialog');
            const titleEl = dialog.querySelector('.dialog-title');
            const bodyEl = dialog.querySelector('.dialog-body');
            const buttonsEl = dialog.querySelector('.dialog-buttons');
            
            titleEl.textContent = title;
            
            // ÊîØÊåÅËá™ÂÆö‰πâÂÜÖÂÆπ
            if (customContent) {
                bodyEl.innerHTML = message + '<br>' + customContent;
            } else {
                bodyEl.textContent = message;
            }
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÊåâÈíÆ
            buttonsEl.innerHTML = '';
            
            // Ê∑ªÂä†Êñ∞ÊåâÈíÆ
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `btn btn-custom ${btn.class || ''}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    btn.onClick();
                    if (btn.keepOpen !== true) {
                        closeSteamDialog();
                    }
                };
                buttonsEl.appendChild(button);
            });
            
            dialog.style.display = 'flex';
            
            // Â¶ÇÊûúÊúâËæìÂÖ•Ê°ÜÔºåËá™Âä®ËÅöÁÑ¶
            const input = dialog.querySelector('input');
            if (input) {
                input.focus();
                // Ê∑ªÂä†ÂõûËΩ¶ÈîÆÊîØÊåÅ
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        const confirmBtn = buttonsEl.querySelector('.btn-primary');
                        if (confirmBtn) {
                            confirmBtn.click();
                        }
                    }
                };
            }
        }

        // Ê∑ªÂä†ÂàùÂßãÂåñÂºπÊ°ÜÁöÑÂáΩÊï∞
        function addSteamDialog() {
            const dialogHTML = `
                <div id="steamDialog" class="steam-dialog" style="display: none;">
                    <div class="steam-dialog-content">
                        <div class="steam-dialog-header">
                            <h4 class="dialog-title"></h4>
                            <button class="close-btn" onclick="closeSteamDialog()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="dialog-body"></div>
                        <div class="dialog-buttons"></div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }
    </script>
</body>
</html>